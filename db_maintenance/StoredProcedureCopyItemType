-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `copyItemType`(IN originalItemTypeId INT(11))
BEGIN

DECLARE createdItemTypeId INTEGER;

DECLARE oldI18nName_id INTEGER;
DECLARE newI18nName_id INTEGER;

DECLARE oldI18nDescription_id INTEGER;
DECLARE newI18nDescription_id INTEGER;

DECLARE demolitionStepCursorFinished INTEGER DEFAULT 0;  
DECLARE originalDemolitionStepId INTEGER;
DECLARE newDemolitionStepId INTEGER;
DECLARE animationDurationVar INTEGER;
DECLARE animationFramesVar INTEGER;
DECLARE stepVar INTEGER;

DECLARE demolitionClipCursorFinished INTEGER DEFAULT 0;  
DECLARE originalDemolitionClipId INTEGER;
DECLARE newDemolitionClipId INTEGER;
DECLARE originaldbClipId INTEGER;


DECLARE oldMovableType_id INTEGER;
DECLARE newMovableType_id INTEGER;

DECLARE oldBuilderType_id INTEGER;
DECLARE newBuilderType_id INTEGER;

DECLARE demolitionStepCursor CURSOR FOR SELECT id, animationDuration, animationFrames, step FROM ITEM_TYPE_DEMOLITION_STEP WHERE itemType_id = originalItemTypeId;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET demolitionStepCursorFinished = 1;

INSERT INTO ITEM_TYPE(TYPE, imageHeight, name, terrainType, 
imageWidth, amount, buildup, damage, explosionRadius, 
price, theRange, speed, health, upgradeProgress,
ttl, boxPickupRange, dropBoxPossibility, dbBoxItemType_id, 
buildupAnimationDuration, buildupAnimationFrames, buildupSteps, 
runtimeAnimationDuration, runtimeAnimationFrames, buildupSound_id, 
commandSound_id,  selectionSound_id, consumingHouseSpace, xpOnKilling, 
boundingBoxRadius, explosionClip_id, unlockCrystals) SELECT TYPE, imageHeight, CONCAT('Copy of ', name), terrainType, 
imageWidth, amount, buildup, damage, explosionRadius, 
price, theRange, speed, health, upgradeProgress,
ttl, boxPickupRange, dropBoxPossibility, dbBoxItemType_id, 
buildupAnimationDuration, buildupAnimationFrames, buildupSteps, 
runtimeAnimationDuration, runtimeAnimationFrames, buildupSound_id, 
commandSound_id,  selectionSound_id, consumingHouseSpace, xpOnKilling, 
boundingBoxRadius, explosionClip_id, unlockCrystals FROM ITEM_TYPE WHERE id = originalItemTypeId;

SET createdItemTypeId = LAST_INSERT_ID();

-- ***************** I18n strings ***************** 
-- dbI18nName_id
SELECT dbI18nName_id INTO oldI18nName_id FROM ITEM_TYPE WHERE id = originalItemTypeId; 
IF oldI18nName_id IS NOT NULL THEN
  INSERT INTO I18N_BUNDLE() VALUES();
  SET newI18nName_id = LAST_INSERT_ID();
  INSERT INTO I18N_STRING(bundle, i18nString, locale) SELECT newI18nName_id, i18nString, locale FROM I18N_STRING WHERE bundle = oldI18nName_id; 
  UPDATE ITEM_TYPE SET dbI18nName_id = newI18nName_id WHERE id = createdItemTypeId; 
END IF;  

-- dbI18nDescription_id
SELECT dbI18nDescription_id INTO oldI18nDescription_id FROM ITEM_TYPE WHERE id = originalItemTypeId; 
IF oldI18nDescription_id IS NOT NULL THEN
  INSERT INTO I18N_BUNDLE() VALUES();
  SET newI18nDescription_id = LAST_INSERT_ID();
  INSERT INTO I18N_STRING(bundle, i18nString, locale) SELECT newI18nDescription_id, i18nString, locale FROM I18N_STRING WHERE bundle = oldI18nDescription_id; 
  UPDATE ITEM_TYPE SET dbI18nDescription_id = newI18nDescription_id WHERE id = createdItemTypeId;
END IF;  

-- ***************** Abilities ***************** 
-- dbMovableType_id
SELECT dbMovableType_id INTO oldMovableType_id FROM ITEM_TYPE WHERE id = originalItemTypeId; 
IF oldMovableType_id IS NOT NULL THEN
  INSERT INTO ITEM_MOVABLE_TYPE(speed) SELECT speed FROM ITEM_MOVABLE_TYPE WHERE id = oldMovableType_id;
  SET newMovableType_id = LAST_INSERT_ID();
  UPDATE ITEM_TYPE SET dbMovableType_id = newMovableType_id WHERE id = createdItemTypeId; 
END IF;  

-- dbBuilderType
SELECT dbBuilderType_id INTO oldBuilderType_id FROM ITEM_TYPE WHERE id = originalItemTypeId; 
IF oldBuilderType_id IS NOT NULL THEN
  INSERT INTO ITEM_BUILDER_TYPE(progress, theRange) SELECT progress, theRange FROM ITEM_BUILDER_TYPE WHERE id = oldBuilderType_id;
  SET newBuilderType_id = LAST_INSERT_ID();
  INSERT INTO ITEM_BUILDER_TYPE_ABLE_TO_BUILD(builderId, itemTypeId) SELECT newBuilderType_id, itemTypeId FROM ITEM_BUILDER_TYPE_ABLE_TO_BUILD WHERE builderId = oldBuilderType_id; 
  UPDATE ITEM_TYPE SET dbBuilderType_id = newBuilderType_id WHERE id = createdItemTypeId; 
END IF;  

-- ***************** Bounding box & images ***************** 
-- itemTypeImages
INSERT INTO ITEM_TYPE_IMAGE (contentType, data, angelIndex, itemType_id, frame, step, type) 
  SELECT contentType, data, angelIndex, createdItemTypeId, frame, step, type FROM ITEM_TYPE_IMAGE WHERE itemType_id = originalItemTypeId;

-- angels
INSERT INTO ITEM_TYPE_ANGELS (itemTypeId, angel) 
  SELECT createdItemTypeId, angel FROM ITEM_TYPE_ANGELS WHERE itemTypeId = originalItemTypeId;

-- demolition
OPEN demolitionStepCursor;
readDemolitionStep: LOOP
	FETCH demolitionStepCursor INTO originalDemolitionStepId, animationDurationVar, animationFramesVar, stepVar;
	IF demolitionStepCursorFinished = 1 THEN 
		LEAVE readDemolitionStep;
	END IF;

	INSERT INTO ITEM_TYPE_DEMOLITION_STEP (animationDuration, animationFrames, step, itemType_id) VALUES (animationDurationVar, animationFramesVar, stepVar, createdItemTypeId);
	SET newDemolitionStepId = LAST_INSERT_ID(); 
    
    CLIP_BLOCK: BEGIN
    DECLARE demolitionClipCursor CURSOR FOR SELECT id, dbClip_id FROM ITEM_TYPE_DEMOLITION_CLIP WHERE dbItemTypeDemolitionStep_id = originalDemolitionStepId;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET demolitionClipCursorFinished = 1;
    OPEN demolitionClipCursor;
 	readDemolitionClip: LOOP
 		FETCH demolitionClipCursor INTO originalDemolitionClipId, originaldbClipId;
 		IF demolitionClipCursorFinished = 1 THEN 
 			LEAVE readDemolitionClip;
 		END IF;

 		INSERT INTO ITEM_TYPE_DEMOLITION_CLIP (dbClip_id, dbItemTypeDemolitionStep_id) VALUES (originaldbClipId, newDemolitionStepId);
 	    SET newDemolitionClipId = LAST_INSERT_ID(); 

 		INSERT INTO ITEM_TYPE_DEMOLITION_CLIP_POSITION (itemTypeDemolitionClipId, xPos, yPos)
 			SELECT newDemolitionClipId, xPos, yPos FROM ITEM_TYPE_DEMOLITION_CLIP_POSITION WHERE itemTypeDemolitionClipId = originalDemolitionClipId; 

 	END LOOP readDemolitionClip;
 	CLOSE demolitionClipCursor;
	END CLIP_BLOCK;

END LOOP readDemolitionStep;
CLOSE demolitionStepCursor;
END